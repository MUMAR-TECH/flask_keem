{% extends "base.html" %}

{% block title %}Student Dashboard - KEEM Driving School{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(220, 38, 38, 0.15);
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card:nth-child(2) {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .stat-card:nth-child(3) {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .stat-card:nth-child(4) {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .progress-ring {
        width: 80px;
        height: 80px;
    }
    
    .progress-ring-circle {
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        stroke: #dc2626;
        stroke-width: 8;
        stroke-linecap: round;
        fill: transparent;
    }
    
    .lesson-item {
        padding: 1rem;
        border-left: 4px solid #e5e7eb;
        transition: all 0.3s;
    }
    
    .lesson-item:hover {
        background: #f9fafb;
        border-left-color: #dc2626;
    }
    
    .lesson-upcoming {
        border-left-color: #3b82f6;
    }
    
    .lesson-completed {
        border-left-color: #10b981;
    }
    
    .payment-item {
        background: #f8fafc;
        border-radius: 10px;
        padding: 1rem;
        border: 2px solid transparent;
        transition: all 0.3s;
    }
    
    .payment-item:hover {
        border-color: #dc2626;
        background: white;
    }
    
    .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: 600;
    }
    
    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }
    
    .badge-warning {
        background: #fef3c7;
        color: #92400e;
    }
    
    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .quick-action {
        padding: 1rem;
        background: #f9fafb;
        border-radius: 10px;
        text-align: center;
        transition: all 0.3s;
    }
    
    .quick-action:hover {
        background: #f3f4f6;
        transform: translateY(-3px);
    }
    
    .greeting-card {
        background: linear-gradient(135deg, #dc2626 0%, #000000 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .greeting-card:before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
    
    .greeting-card:after {
        content: '';
        position: absolute;
        bottom: -50%;
        left: -50%;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Welcome Section -->
    <div class="greeting-card mb-8">
        <div class="relative z-10">
            <div class="flex flex-col md:flex-row md:items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">Welcome back, {{ session.student_name }}!</h1>
                    <p class="text-red-100">Here's your learning dashboard for {{ student.course.name if student.course else 'your course' }}</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <div class="text-sm text-red-200">Student ID: {{ session.student_number }}</div>
                    <div class="text-sm text-red-200">Branch: {{ student.branch.name if student.branch else 'N/A' }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="stat-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90">Course Progress</p>
                    <h2 class="text-3xl font-bold mt-1">{{ student.progress_percentage }}%</h2>
                </div>
                <i class="fas fa-chart-line text-3xl opacity-50"></i>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90">Upcoming Lessons</p>
                    <h2 class="text-3xl font-bold mt-1">{{ upcoming_lessons|length }}</h2>
                </div>
                <i class="fas fa-calendar-alt text-3xl opacity-50"></i>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90">Payments Made</p>
                    <h2 class="text-3xl font-bold mt-1">{{ payments|length }}</h2>
                </div>
                <i class="fas fa-money-check-alt text-3xl opacity-50"></i>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm opacity-90">Days Remaining</p>
                    <h2 class="text-3xl font-bold mt-1">
                        {% if student.course_end_date %}
                            {{ (student.course_end_date - today).days }}
                        {% else %}
                            -
                        {% endif %}
                    </h2>
                </div>
                <i class="fas fa-clock text-3xl opacity-50"></i>
            </div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Course Progress -->
            <div class="dashboard-card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold gradient-text">Course Progress</h2>
                    <span class="text-sm font-medium {% if student.progress_percentage >= 80 %}text-green-600{% elif student.progress_percentage >= 50 %}text-yellow-600{% else %}text-red-600{% endif %}">
                        {{ student.progress_percentage }}% Complete
                    </span>
                </div>
                
                <div class="flex items-center mb-6">
                    <div class="progress-ring mr-6">
                        <svg viewBox="0 0 100 100" class="progress-ring">
                            <circle class="progress-ring-circle-bg" cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="transparent"/>
                            <circle class="progress-ring-circle" cx="50" cy="50" r="40" stroke-dasharray="251.2" 
                                    stroke-dashoffset="{{ 251.2 - (251.2 * student.progress_percentage / 100) }}"/>
                        </svg>
                    </div>
                    
                    <div class="flex-1">
                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Completed</span>
                            <span>{{ completed_lessons|length }} lessons</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: {{ student.progress_percentage }}%"></div>
                        </div>
                        
                        <div class="mt-4 text-sm">
                            <div class="flex items-center justify-between mb-2">
                                <span class="flex items-center">
                                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                    Theory Classes
                                </span>
                                <span class="font-medium">8/10 sessions</span>
                            </div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="flex items-center">
                                    <i class="fas fa-car text-blue-500 mr-2"></i>
                                    Practical Driving
                                </span>
                                <span class="font-medium">12/20 sessions</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="flex items-center">
                                    <i class="fas fa-exam text-purple-500 mr-2"></i>
                                    Final Test
                                </span>
                                <span class="font-medium">Not scheduled</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <a href="/student-portal/lesson-schedule" class="text-red-600 hover:text-red-700 font-medium">
                        <i class="fas fa-calendar-alt mr-2"></i>View Full Schedule
                    </a>
                </div>
            </div>
            
            <!-- Upcoming Lessons -->
            <div class="dashboard-card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold gradient-text">Upcoming Lessons</h2>
                    <a href="/student-portal/lesson-schedule" class="text-sm text-red-600 hover:text-red-700 font-medium">
                        View All <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
                
                {% if upcoming_lessons %}
                <div class="space-y-4">
                    {% for lesson in upcoming_lessons %}
                    <div class="lesson-item lesson-upcoming">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-gray-800">{{ lesson.title }}</h4>
                                <div class="flex items-center text-sm text-gray-600 mt-1">
                                    <i class="far fa-calendar mr-2"></i>
                                    {{ lesson.scheduled_date.strftime('%A, %B %d') }}
                                    <i class="far fa-clock ml-4 mr-2"></i>
                                    {{ lesson.scheduled_time.strftime('%I:%M %p') }}
                                </div>
                                {% if lesson.instructor_rel %}
                                <div class="text-sm text-gray-500 mt-1">
                                    <i class="fas fa-user-tie mr-2"></i>Instructor: {{ lesson.instructor_rel.name }}
                                </div>
                                {% endif %}
                            </div>
                            <span class="badge badge-success">Scheduled</span>
                        </div>
                        
                        {% if lesson.materials %}
                        <div class="mt-3">
                            <p class="text-sm text-gray-600 mb-1">Required Materials:</p>
                            <p class="text-sm">{{ lesson.materials }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-calendar-check text-gray-300 text-4xl mb-4"></i>
                    <p class="text-gray-500">No upcoming lessons scheduled</p>
                    <a href="/student-portal/lesson-schedule" class="text-red-600 hover:text-red-700 font-medium mt-2 inline-block">
                        View lesson calendar
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="space-y-8">
            <!-- Payment Overview -->
            <div class="dashboard-card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold gradient-text">Payment Status</h2>
                    <a href="/student-portal/payment-history" class="text-sm text-red-600 hover:text-red-700 font-medium">
                        Details
                    </a>
                </div>
                
                <div class="text-center mb-6">
                    <div class="text-3xl font-bold text-gray-800 mb-2">K{{ student.balance|format_currency }}</div>
                    <p class="text-sm text-gray-600">Balance Remaining</p>
                </div>
                
                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Total Course Fee:</span>
                        <span class="font-medium">K{{ student.total_fee|format_currency }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Amount Paid:</span>
                        <span class="font-medium text-green-600">K{{ student.amount_paid|format_currency }}</span>
                    </div>
                    <div class="flex justify-between text-sm font-bold border-t pt-3 mt-3">
                        <span>Balance:</span>
                        <span class="{% if student.balance > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                            K{{ student.balance|format_currency }}
                        </span>
                    </div>
                </div>
                
                {% if student.balance > 0 %}
                <div class="mt-6">
                    <a href="/student-portal/payment-history" class="block text-center bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700 transition">
                        Make Payment
                    </a>
                </div>
                {% endif %}
            </div>
            
            <!-- Quick Actions -->
            <div class="dashboard-card">
                <h2 class="text-xl font-bold gradient-text mb-6">Quick Actions</h2>
                <div class="grid grid-cols-2 gap-4">
                    <a href="/student-portal/documents" class="quick-action">
                        <i class="fas fa-file-pdf text-red-600 text-2xl mb-2"></i>
                        <p class="font-medium text-sm">Documents</p>
                    </a>
                    <a href="/student-portal/profile" class="quick-action">
                        <i class="fas fa-user-edit text-blue-600 text-2xl mb-2"></i>
                        <p class="font-medium text-sm">Profile</p>
                    </a>
                    <a href="/student-portal/lesson-schedule" class="quick-action">
                        <i class="fas fa-calendar-alt text-green-600 text-2xl mb-2"></i>
                        <p class="font-medium text-sm">Schedule</p>
                    </a>
                    <a href="/student-portal/application-status" class="quick-action">
                        <i class="fas fa-file-alt text-purple-600 text-2xl mb-2"></i>
                        <p class="font-medium text-sm">Application</p>
                    </a>
                </div>
            </div>
            
            <!-- Recent Payments -->
            <div class="dashboard-card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold gradient-text">Recent Payments</h2>
                    <a href="/student-portal/payment-history" class="text-sm text-red-600 hover:text-red-700 font-medium">
                        History
                    </a>
                </div>
                
                {% if payments %}
                <div class="space-y-4">
                    {% for payment in payments %}
                    <div class="payment-item">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">{{ payment.payment_number }}</span>
                            <span class="font-bold text-green-600">K{{ payment.amount|format_currency }}</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>{{ payment.payment_date.strftime('%b %d, %Y') }}</span>
                            <span class="capitalize">{{ payment.payment_method }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-receipt text-gray-300 text-3xl mb-3"></i>
                    <p class="text-gray-500 text-sm">No payment history</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Course Info -->
            <div class="dashboard-card">
                <h2 class="text-xl font-bold gradient-text mb-4">Course Information</h2>
                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Course:</span>
                        <span class="font-medium">{{ student.course.name if student.course else 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Start Date:</span>
                        <span class="font-medium">{{ student.course_start_date.strftime('%b %d, %Y') if student.course_start_date else 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">End Date:</span>
                        <span class="font-medium">{{ student.course_end_date.strftime('%b %d, %Y') if student.course_end_date else 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Instructor:</span>
                        <span class="font-medium">{{ student.instructor.name if student.instructor else 'Not assigned' }}</span>
                    </div>
                </div>
                
                <div class="mt-6">
                    <a href="/student-portal/profile" class="text-red-600 hover:text-red-700 font-medium text-sm">
                        <i class="fas fa-info-circle mr-2"></i>View Full Details
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Completed Lessons -->
    {% if completed_lessons %}
    <div class="dashboard-card mt-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold gradient-text">Recently Completed</h2>
            <span class="text-sm text-gray-600">{{ completed_lessons|length }} lessons completed</span>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% for lesson in completed_lessons[:3] %}
            <div class="lesson-item lesson-completed">
                <h4 class="font-bold text-gray-800">{{ lesson.title }}</h4>
                <div class="text-sm text-gray-600 mt-1">
                    <i class="far fa-calendar mr-2"></i>
                    {{ lesson.completion_date.strftime('%b %d') if lesson.completion_date else 'N/A' }}
                </div>
                {% if lesson.score %}
                <div class="mt-2">
                    <span class="text-sm font-medium">Score: {{ lesson.score }}/100</span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Important Notices -->
    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded-lg mt-8">
        <div class="flex items-start">
            <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-4 mt-1"></i>
            <div>
                <h3 class="font-bold text-lg mb-2">Important Notices</h3>
                <ul class="space-y-2 text-gray-700">
                    <li class="flex items-start">
                        <i class="fas fa-check text-yellow-500 mt-1 mr-2"></i>
                        <span>Always bring your student ID for lessons</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-yellow-500 mt-1 mr-2"></i>
                        <span>Report any schedule conflicts 24 hours in advance</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-yellow-500 mt-1 mr-2"></i>
                        <span>Check your portal regularly for updates</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Update progress ring animation
document.addEventListener('DOMContentLoaded', function() {
    const progressCircle = document.querySelector('.progress-ring-circle');
    if (progressCircle) {
        const radius = progressCircle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        
        progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
        progressCircle.style.strokeDashoffset = circumference;
        
        const offset = circumference - ({{ student.progress_percentage }} / 100 * circumference);
        setTimeout(() => {
            progressCircle.style.transition = 'stroke-dashoffset 1.5s ease-in-out';
            progressCircle.style.strokeDashoffset = offset;
        }, 500);
    }
    
    // Auto-refresh dashboard every 5 minutes
    setInterval(() => {
        // In a real app, this would fetch updated data
        console.log('Auto-refreshing dashboard data...');
    }, 300000);
});
</script>
{% endblock %}